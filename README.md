# SfM
# (Title & Insert GIF)
Pipeline to reconstruct a 3D structure of a scene based on a set of images from a ros2 bag.

## Overview
Structure from Motion (SfM) is a technique used to reconstruct the 3D structure of a scene from a set of 2D images captured from different viewpoints. COLMAP is a SfM pipeline with command-line interface and features for reconstruction of images collections.
On the other hand, ROS2 is a very popular robot operating system with features like ros2bags to record data for post processing.

This project consists of 2 stages:
First stage is an Image processing pipeline where a ros2 bag is processed to extract and structure the needed information for the reconstruction.
The second stage is a COLMAP pipeline that takes as input the processed data of the first stage and produces a sparse point cloud with estimated camera poses and optional a dense point cloud of the scene.

## Image processing pipeline
Rosbag expected topics and type:
- Cameras images: sensor_msgs.msg.Image or sensor_msgs.msg.CompressedImage
- Cameras info: sensor_msgs.msg.CameraInfo
- GPS info: sensor_msgs.msg.NavSatFix
- Transform info: geometry_msgs.msg.TransformStamped

Moving objects as pedestrians, cars, etc... lead to failures in the COLMAP pipeline. To mitigate their impact, COLMAP filters regions of the images based on masks, which are created using the Ultralitic's "yolov8x-seg" segmentation model that segments people, cars, motorcicles and trucks.

(insert comparisson mask vs filtered image)

To use this pipeline, first set the configuration file "config_dataset.yaml" specifying all the needed parameters and then run "dataset_generator.py ".

As output is obtained a folder with the undistorted images, masks and text files with pose information and lists needed for COLMAP pipeline.

(insert image with folder output)

Recording recomendations:

## COLMAP pipeline
This pipeline was designed to automate the command line flow and deliver a reconstruction using the information from the last stage. COLMAP is a very extensive tool with many functionalities and parameters (https://colmap.github.io/) and this pipeline incorporates some of the main functionalities of COLMAP allowing multi-camera reconstructions from known and unknown camera poses, different matchers and model scalators.

To use this pipeline, first set the configuration file "config_colmap.yaml" specifying all the needed parameters and then run "colmap_pipeline.py ".

As output, a new folder is added to the project, containing all the 3D models generated by COLMAP and files with pose data.

Pipeline for known camera poses:

Pipeline for unknown camera poses:

(insert image with folder outputs)

(Add results page with real dataset and simulated dataset)

## Requirements
- Docker:
sudo apt update
sudo apt-get install ca-certificates curl gnupg
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

-# Make sure to have nvidia driver for GPU and check with
nvidia-smi

- Cuda toolkit:
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin
sudo mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600
wget https://developer.download.nvidia.com/compute/cuda/12.4.1/local_installers/cuda-repo-ubuntu2204-12-4-local_12.4.1-550.54.15-1_amd64.deb
sudo dpkg -i cuda-repo-ubuntu2204-12-4-local_12.4.1-550.54.15-1_amd64.deb
sudo cp /var/cuda-repo-ubuntu2204-12-4-local/cuda-*-keyring.gpg /usr/share/keyrings/
sudo apt-get update
sudo apt-get -y install cuda-toolkit-12-4
-# Add to .bashrc
export PATH=/usr/local/cuda-12.4/bin${PATH:+:${PATH}}
export LD_LIBRARY_PATH=/usr/local/cuda-12.4/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}
-# verify: nvcc --version


- Nvidia-docker toolkit:
NVIDIA GPU/CUDA and installed drivers.
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit
sudo systemctl restart docker

## Run project
After clone the repository, run:

docker build -t="colmap:cuda" .

-# In some cases, you may have to explicitly specify the compute architecture (compute capability):
-#   docker build -t="colmap:latest" --build-arg CUDA_ARCHITECTURES=86 .
docker run --gpus all -w /working -v $1:/working -it colmap:cuda
-# Replace with your working directory (path to cloned repository) as this:

Ros2+Colmap CLI
docker run \
    --gpus all \
    -w /working \
    -v /home/user/Documents/.../SfM_CUDA:/working \
    -it colmap:cuda

Ros2+Enable Colmap GUI
docker run \
    -e QT_XCB_GL_INTEGRATION=xcb_egl \
    -e DISPLAY=$DISPLAY \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -w /working \
    -v /home/user/Documents/.../SfM_CUDA:/working \
    --gpus all \
    --privileged \
    -it colmap:cuda \
    # colmap gui

GUI Troubleshooting:
xhost +


## Contact Me
https://www.linkedin.com/in/dasv1298/

